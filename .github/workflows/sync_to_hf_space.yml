name: Sync to Hugging Face Space

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Evită deploy-uri paralele; păstrează doar cel mai recent job
concurrency:
  group: hf-space-deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Push to HF Space
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ vars.HF_USERNAME }}
          SPACE_NAME: ${{ vars.SPACE_NAME }}
        run: |
          set -e  # fail-fast: oprește la prima eroare
          if [ -z "${HF_TOKEN}" ]; then
            echo "Lipsește secretul HF_TOKEN (Hugging Face token cu write)"; exit 1;
          fi
          if [ -z "${HF_USERNAME}" ] || [ -z "${SPACE_NAME}" ]; then
            echo "Setează Repository variables HF_USERNAME și SPACE_NAME în GitHub -> Settings -> Variables -> Actions"; exit 1;
          fi

          SPACE_URL="https://huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}"
          SPACE_REMOTE="https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${SPACE_NAME}"

          echo "Pushing to ${SPACE_URL}"
          # Adaugă sau actualizează remote-ul 'space'
          if git remote get-url space > /dev/null 2>&1; then
            git remote set-url space "${SPACE_REMOTE}"
          else
            git remote add space "${SPACE_REMOTE}"
          fi

          # Împinge HEAD către main-ul Space-ului (force pentru aliniere inițială)
          git push --force space HEAD:main
